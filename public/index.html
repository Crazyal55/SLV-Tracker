<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLV Covered Calls Strategy</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a202c 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #48bb78, #38a169);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #718096;
            margin-top: 10px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card h3 {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .card .value.green { color: #48bb78; }
        .card .value.blue { color: #4299e1; }
        .card .value.purple { color: #9f7aea; }
        .card .value.orange { color: #ed8936; }

        .card .subtext {
            color: #718096;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .actions-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .settings-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-row label {
            color: #718096;
        }

        .setting-row input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            width: 100px;
            text-align: right;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(72, 187, 120, 0.3);
        }

        .history-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .calls-table {
            width: 100%;
            border-collapse: collapse;
        }

        .calls-table th,
        .calls-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .calls-table th {
            color: #718096;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .calls-table .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .status.open {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
        }

        .status.closed {
            background: rgba(160, 174, 192, 0.2);
            color: #a0aec0;
        }

        .btn-close {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            border: 1px solid rgba(237, 137, 54, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .btn-close:hover {
            background: rgba(237, 137, 54, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .refresh-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 16px;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìà SLV Covered Calls</h1>
            <p class="subtitle">Generate monthly income by selling calls 3% above strike price</p>
        </header>

        <div class="dashboard" id="dashboard">
            <div class="card">
                <h3>Current SLV Price</h3>
                <div class="value blue">$<span id="currentPrice">0.00</span></div>
                <div class="subtext">iShares Silver Trust</div>
            </div>

            <div class="card">
                <h3>Next Strike Price</h3>
                <div class="value purple">$<span id="strikePrice">0.00</span></div>
                <div class="subtext">3% above current</div>
            </div>

            <div class="card">
                <h3>Estimated Premium</h3>
                <div class="value green">$<span id="estimatedPremium">0.00</span></div>
                <div class="subtext">Per share, <span id="premiumPct">0</span>% above current</div>
            </div>

            <div class="card">
                <h3>Estimated Income</h3>
                <div class="value orange">$<span id="estimatedIncome">0.00</span></div>
                <div class="subtext"><span id="sharesOwned">0</span> shares</div>
            </div>
        </div>

        <div class="main-grid">
            <div class="chart-container">
                <div style="position: relative;">
                    <button class="refresh-btn" onclick="refreshPrices()">üîÑ Refresh</button>
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="actions-panel">
                <h2 class="section-title">Strategy Settings</h2>

                <div class="settings-grid">
                    <div class="setting-row">
                        <label>Shares Owned</label>
                        <input type="number" id="sharesOwnedInput" value="100">
                    </div>
                    <div class="setting-row">
                        <label>Premium % Above</label>
                        <input type="number" id="premiumPctInput" value="3" step="0.5">
                    </div>
                    <div class="setting-row">
                        <label>Next Expiry</label>
                        <span style="color: #718096;" id="nextExpiry">Loading...</span>
                    </div>
                    <div class="setting-row">
                        <label>Days to Expiry</label>
                        <span style="color: #718096;" id="daysToExpiry">Loading...</span>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="createCall()">üí∞ Sell Covered Call</button>
                <button class="btn btn-secondary" onclick="updateSettings()" style="margin-top: 10px;">‚öôÔ∏è Update Settings</button>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="color: #718096; font-size: 0.85rem;">
                        <strong>Total Income (Closed Calls):</strong> $<span id="totalIncome">0.00</span>
                    </div>
                    <div style="color: #718096; font-size: 0.85rem; margin-top: 5px;">
                        <strong>Annualized Return:</strong> <span id="annualizedReturn">0</span>%
                    </div>
                </div>
            </div>
        </div>

        <div class="history-section">
            <h2 class="section-title">Call History</h2>
            <div id="callsList">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let priceChart;

        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'SLV Price',
                        data: [],
                        borderColor: '#4299e1',
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(26, 32, 44, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#a0aec0',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#718096',
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255,255,255,0.05)'
                            },
                            ticks: {
                                color: '#718096',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fetch status
        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // Update dashboard
                document.getElementById('currentPrice').textContent = data.currentPrice.toFixed(2);
                document.getElementById('strikePrice').textContent = data.strikePrice.toFixed(2);
                document.getElementById('estimatedPremium').textContent = data.estimatedPremium.toFixed(2);
                document.getElementById('premiumPct').textContent = data.premiumPct;
                document.getElementById('estimatedIncome').textContent = data.estimatedIncome.toFixed(2);
                document.getElementById('sharesOwned').textContent = data.sharesOwned;
                document.getElementById('sharesOwnedInput').value = data.sharesOwned;
                document.getElementById('premiumPctInput').value = data.premiumPct;
                document.getElementById('nextExpiry').textContent = data.nextExpiry;
                document.getElementById('daysToExpiry').textContent = data.daysToExpiry;
                document.getElementById('totalIncome').textContent = data.totalIncome.toFixed(2);
                document.getElementById('annualizedReturn').textContent = data.annualizedReturn.toFixed(1);

                // Update chart
                if (data.recentPrices) {
                    priceChart.data.labels = data.recentPrices.map(p => p.date);
                    priceChart.data.datasets[0].data = data.recentPrices.map(p => p.close);
                    priceChart.update();
                }

            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Fetch calls
        async function fetchCalls() {
            try {
                const res = await fetch('/api/calls');
                const calls = await res.json();

                const container = document.getElementById('callsList');

                if (calls.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No calls yet</h3>
                            <p>Sell your first covered call to start generating income!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table class="calls-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Strike</th>
                                <th>Premium</th>
                                <th>Income</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calls.map(call => `
                                <tr>
                                    <td>${call.created_at.split('T')[0]}</td>
                                    <td>$${call.strike_price.toFixed(2)}</td>
                                    <td>$${call.premium.toFixed(2)} (${call.premium_pct}%)</td>
                                    <td>$${call.income.toFixed(2)}</td>
                                    <td><span class="status ${call.status}">${call.status}</span></td>
                                    <td>
                                        ${call.status === 'open' ? `
                                            <button class="btn-close" onclick="closeCall(${call.id})">Close</button>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error fetching calls:', error);
            }
        }

        // Create call
        async function createCall() {
            try {
                const res = await fetch('/api/calls', { method: 'POST' });
                if (res.ok) {
                    fetchStatus();
                    fetchCalls();
                }
            } catch (error) {
                console.error('Error creating call:', error);
            }
        }

        // Close call
        async function closeCall(id) {
            if (!confirm('Close this call position?')) return;

            try {
                const res = await fetch(`/api/calls/${id}/close`, { method: 'POST' });
                if (res.ok) {
                    fetchStatus();
                    fetchCalls();
                }
            } catch (error) {
                console.error('Error closing call:', error);
            }
        }

        // Update settings
        async function updateSettings() {
            const sharesOwned = document.getElementById('sharesOwnedInput').value;
            const premiumPct = document.getElementById('premiumPctInput').value;

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sharesOwned, premiumPct })
                });

                if (res.ok) {
                    fetchStatus();
                }
            } catch (error) {
                console.error('Error updating settings:', error);
            }
        }

        // Refresh prices
        async function refreshPrices() {
            try {
                await fetch('/api/refresh', { method: 'POST' });
                fetchStatus();
            } catch (error) {
                console.error('Error refreshing prices:', error);
            }
        }

        // Initialize
        initChart();
        fetchStatus();
        fetchCalls();

        // Refresh every 5 minutes
        setInterval(fetchStatus, 300000);
    </script>
</body>
</html>
